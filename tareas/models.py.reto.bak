
from django.db import models

# Modelo para avisos administrativos
class Aviso(models.Model):
    NIVEL_CHOICES = [
        ("INFO", "Info"),
        ("WARNING", "Advertencia"),
        ("ERROR", "Error"),
        ("CRITICAL", "Crítico"),
    ]
    mensaje = models.TextField()
    nivel = models.CharField(max_length=10, choices=NIVEL_CHOICES, default="INFO")
    creado_en = models.DateTimeField(auto_now_add=True)
    visto = models.BooleanField(default=False)
    usuario = models.ForeignKey('auth.User', null=True, blank=True, on_delete=models.SET_NULL, related_name='avisos')

    def __str__(self):
        return f"[{self.nivel}] {self.mensaje[:40]}{'...' if len(self.mensaje)>40 else ''}"

# Modelo para Retos
class Reto(models.Model):
    fecha_conseguido = models.DateField(null=True, blank=True, help_text="Fecha en la que se marcó como conseguido")
    ESTADO_CHOICES = [
        ("pendiente", "Pendiente de validación"),
        ("aprobado", "Aprobado"),
        ("rechazado", "Rechazado"),
        ("conseguido", "Conseguido"),
    ]
    estado = models.CharField(max_length=20, choices=ESTADO_CHOICES, default='pendiente')
    inicio = models.DateField(null=True, blank=True)
    fin = models.DateField(null=True, blank=True)
    tipo = models.CharField(max_length=50, blank=True)
    retador = models.ForeignKey('Miembro', null=True, blank=True, on_delete=models.SET_NULL, related_name='retos_propuestos')
    retado = models.ForeignKey('Miembro', null=False, blank=False, on_delete=models.PROTECT, related_name='retos_recibidos')
    marcas_objetivo = models.CharField(max_length=200, blank=True)
    es_auto_reto = models.BooleanField(default=False)
    es_privado = models.BooleanField(default=False, help_text="Si está activo, el reto solo será visible para el retador y el retado.")
    from decimal import Decimal
    penalizacion = models.DecimalField(max_digits=6, decimal_places=2, default=Decimal('0.00'), help_text="Penalización en euros si no se cumple el reto")
    ESTADO_CHOICES = [
        ("pendiente", "Pendiente de validación"),
        ("aprobado", "Aprobado"),
        ("rechazado", "Rechazado"),
    ]
    RECURRENCIA_CHOICES = [
        ('none', 'Sin repetición'),
        ('diaria', 'Diaria'),
        ('semanal', 'Semanal'),
        ('mensual', 'Mensual'),
        ('anual', 'Anual'),
    ]

    ESTADO_CHOICES = [
        ('pendiente', 'Pendiente'),
        ('realizada', 'Realizada por miembro'),
        ('aprobada', 'Aprobada por administrador'),
    ]

    nombre = models.CharField(max_length=200)
    descripcion = models.TextField(blank=True)
    icono = models.CharField(max_length=20, default="", blank=True)
    categoria = models.ForeignKey('Categoria', null=True, blank=True, on_delete=models.SET_NULL, related_name='retos')
    tag = models.CharField(max_length=50, blank=True)
    puntuacion = models.PositiveIntegerField(default=1)
    premio = models.DecimalField(max_digits=6, decimal_places=2, default=0.10, help_text="Premio en euros (ejemplo: 0.20)")
    tiempo_estimado = models.PositiveIntegerField(default=30, help_text="Tiempo estimado en minutos")
    creado_por = models.ForeignKey('auth.User', null=True, blank=True, on_delete=models.SET_NULL, related_name='retos_creados')

    recurrencia_tipo = models.CharField(max_length=10, choices=RECURRENCIA_CHOICES, default='none', help_text="Tipo de recurrencia")
    recurrencia_dias = models.CharField(max_length=20, blank=True, help_text="Días de la semana separados por coma (ej: 0,2,4)")
    recurrencia_dia_mes = models.PositiveIntegerField(null=True, blank=True, help_text="Día del mes (1-31)")
    recurrencia_mes = models.PositiveIntegerField(null=True, blank=True, help_text="Mes (1-12, solo anual)")
    recurrencia_fecha_inicio = models.DateField(null=True, blank=True, help_text="Fecha de inicio de la recurrencia")
    recurrencia_fecha_fin = models.DateField(null=True, blank=True, help_text="Fecha de fin de la recurrencia")

    def __str__(self):
        return self.nombre


class Categoria(models.Model):
    nombre = models.CharField(max_length=100, unique=True)
    descripcion = models.TextField(blank=True)

    def __str__(self):
        return self.nombre

class Miembro(models.Model):
    nombre = models.CharField(max_length=100, unique=True)
    color_hex = models.CharField(max_length=7, default="#888888")
    icono = models.CharField(max_length=20, default="", blank=True)
    usuario = models.OneToOneField('auth.User', null=True, blank=True, on_delete=models.SET_NULL, related_name='miembro')
    saldo = models.DecimalField(max_digits=8, decimal_places=2, default=0.00, help_text="Saldo acumulado en euros por retos")
    puntos = models.PositiveIntegerField(default=0, help_text="Puntos acumulados por retos")

    def __str__(self) -> str:
        return self.nombre


class Tarea(models.Model):
    RECURRENCIA_CHOICES = [
        ('none', 'Sin repetición'),
        ('diaria', 'Diaria'),
        ('semanal', 'Semanal'),
        ('mensual', 'Mensual'),
        ('anual', 'Anual'),
    ]
    recurrencia_tipo = models.CharField(max_length=10, choices=RECURRENCIA_CHOICES, default='none')
    # Días de la semana para diaria/semanal (0=Lunes, 6=Domingo)
    recurrencia_dias = models.CharField(max_length=20, blank=True, help_text="Días de la semana separados por coma (ej: 0,2,4)")
    # Día del mes para mensual/anual
    recurrencia_dia_mes = models.PositiveIntegerField(null=True, blank=True, help_text="Día del mes (1-31)")
    # Mes para anual
    recurrencia_mes = models.PositiveIntegerField(null=True, blank=True, help_text="Mes (1-12, solo anual)")
    # Rango de fechas para la recurrencia
    recurrencia_fecha_inicio = models.DateField(null=True, blank=True, help_text="Fecha de inicio de la recurrencia")
    recurrencia_fecha_fin = models.DateField(null=True, blank=True, help_text="Fecha de fin de la recurrencia")
    premio = models.DecimalField(max_digits=6, decimal_places=2, default=0.10, help_text="Premio en euros (ejemplo: 0.20)")
    tiempo_estimado = models.PositiveIntegerField(default=30, help_text="Tiempo estimado en minutos")
    ESTADO_CHOICES = [
        ('pendiente', 'Pendiente'),
        ('realizada', 'Realizada por miembro'),
        ('aprobada', 'Aprobada por administrador'),
    ]

    nombre = models.CharField(max_length=200)
    descripcion = models.TextField(blank=True)
    icono = models.CharField(max_length=20, default="", blank=True)
    categoria = models.ForeignKey('Categoria', null=True, blank=True, on_delete=models.SET_NULL, related_name='tareas')
    tag = models.CharField(max_length=50, blank=True)
    puntuacion = models.PositiveIntegerField(default=1)

    creado_por = models.ForeignKey('auth.User', null=True, blank=True, on_delete=models.SET_NULL, related_name='tareas_creadas')

    def __str__(self):
        return self.nombre


class Evento(models.Model):
    tarea = models.ForeignKey(Tarea, on_delete=models.CASCADE, related_name='eventos')
    miembro = models.ForeignKey(Miembro, on_delete=models.CASCADE, related_name='eventos')
    inicio = models.DateTimeField()
    fin = models.DateTimeField()
    estado = models.CharField(max_length=20, choices=Tarea.ESTADO_CHOICES, default='pendiente')
    creado_por = models.ForeignKey('auth.User', null=True, blank=True, on_delete=models.SET_NULL, related_name='eventos_creados')
    actualizado_en = models.DateTimeField(auto_now=True)
    creado_en = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['inicio']

    def __str__(self):
        return f"{self.tarea.nombre} - {self.miembro.nombre} ({self.inicio:%Y-%m-%d %H:%M})"

    @property
    def duracion_minutos(self) -> int:
        return int((self.fin - self.inicio).total_seconds() // 60)
